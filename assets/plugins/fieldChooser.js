!function(e){e.fn.fieldChooser=function(t,n,i){function l(e){var t=e.offset();return{left:t.left,right:t.left+e.width(),top:t.top,bottom:t.top+e.height()}}function o(e,t){return{left:t.left,right:e.right+t.left-e.left,top:t.top,bottom:e.bottom+t.top-e.top}}function s(e,t,n){var i=l(e),s=l(t);s=o(s,n);var r=!0;return s.right<i.left?r=!1:s.left>i.right?r=!1:s.bottom<i.top?r=!1:s.top>i.bottom&&(r=!1),r}function r(e,t){if(a)if(a==t);else{var n=d.getSourceList();t==d.getSourceList()&&(n=d.getDestinationList()),n.clearSelection(!0)}a=t}var c=this;if(this.getOptions)return this;var d=this,a=null,f=function(t,n){var i=e(t);i.addClass("fc-field-list"),i.attr("tabIndex",n);var l=-1,o=-1,s=function(t){t.addClass("fc-field"),t.attr("tabIndex",n),t.off("click.field"),t.on("click.field",function(t){t.stopPropagation(),t.preventDefault();var n=e(this),i=d.getFieldList(n);t.ctrlKey||t.metaKey?i.toggleFieldSelection(n):t.shiftKey?i.selectTo(n):i.selectField(n),v=i})};return s(i.children()),i.selectAt=function(e){this.clearSelection(!0);var t=i.getFields();e>=t.length&&(e=t.length-1);var n=null;e>=0&&(n=t.eq(e)),n?(n.addClass("fc-selected"),l=e,i.scrollToField(n)):l=-1,i.trigger("selectionChanged",[i])},i.extendSelection=function(e){var t=this.getSelectedIndex(),n=this.getExtendedSelectionIndex(),s=n,r=!0;e?(0>s&&(s=i.getFields().length,l=s-1),n>t?r=!1:s--):(0>s&&(l=0),t>n?r=!1:s++);var c=i.getFields();if(0>s||s>=c.length);else{var d=c.eq(s);r?d.addClass("fc-selected"):(d.removeClass("fc-selected"),e?s--:s++,s>=0&&s<c.length&&(d=c.eq(s))),i.scrollToField(d),i.trigger("selectionChanged",[i]),o=s}},i.selectField=function(e){this.clearSelection(!0),e.addClass("fc-selected"),l=e.index(),i.trigger("selectionChanged",[i])},i.toggleFieldSelection=function(e){e.toggleClass("fc-selected"),e.hasClass("fc-selected")?(l=e.index(),o=-1):l==e.index()&&(l=i.children(".fc-selected").first().index()),i.trigger("selectionChanged",[i])},i.selectTo=function(e){var t=e;"object"==typeof e&&(t=e.index()),-1==l&&(l=0);var n=i.children();if(t>l)for(var s=l;s<n.length;s++)t>=s?n.eq(s).addClass("fc-selected"):n.eq(s).removeClass("fc-selected");else for(var s=l;s>=0;s--)s>=t?n.eq(s).addClass("fc-selected"):n.eq(s).removeClass("fc_selected");o=t,i.trigger("selectionChanged",[i])},i.getSelectedIndex=function(){return l},i.getExtendedSelectionIndex=function(){var e=o;return 0>e&&(e=l),e},i.getSelection=function(){return this.children(".fc-selected")},i.clearSelection=function(e){l=-1,o=-1,this.children().removeClass("fc-selected"),e||i.trigger("selectionChanged",[i])},i.add=function(e){return s(e),e.appendTo(i),i},i.getFields=function(){return i.children()},i.scrollToField=function(e){var t=i.position().top,n=i.scrollTop(),l=i.height(),o=n+l,s=e.outerHeight(),r=n+e.position().top-t,c=r+s;n>r?i.scrollTop(r):c>o&&i.scrollTop(n+(c-o))},i.sortable({connectWith:".fc-field-list",cursor:"move",opacity:.75,cursorAt:{left:5,top:5},helper:function(t,n){n.hasClass("fc-selected")||i.selectField(n);var l=c.getOptions().helper(i),o=i.getSelection().clone();return l||(l=e("<div/>").append(o)),n.data("selection",o),n.siblings(".fc-selected").remove(),l}}),i},g=e.extend({},e.fn.fieldChooser.defaults,i),h=parseInt(this.attr("tabIndex"));isNaN(h)&&(h=0),this.removeAttr("tabIndex");var u=new f(t,h).addClass("fc-source-fields"),p=new f(n,h).addClass("fc-destination-fields"),v=null;return this.getOptions=function(){return g},this.getSourceList=function(){return u},this.getDestinationList=function(){return p},this.getFieldList=function(e){var t=p;return e.parent().hasClass("fc-source-fields")&&(t=u),t},this.destroy=function(){this.getOptions=null,u.sortable("destroy"),p.sortable("destroy")},p.on("sortstop",function(e,t){var n=t.item.data("selection");s(u,t.item,t.offset)?(v=u,u.add(n),p.clearSelection(),u.trigger("selectionChanged",[u]),d.trigger("listChanged",[n,u]),t.item.after(n).remove()):s(p,t.item,t.offset)?(v=p,p.add(n),p.trigger("selectionChanged",[p]),d.trigger("listChanged",[n,p]),t.item.after(n).remove()):(p.getSelection().remove(),u.add(n),u.scrollToField(n),p.clearSelection(),u.trigger("selectionChanged",[u]),v=u,d.trigger("listChanged",[n,u]))}),u.on("sortstop",function(e,t){var n=t.item.data("selection");s(p,t.item,t.offset)?(v=p,p.add(n),u.clearSelection(),p.trigger("selectionChanged",[p]),d.trigger("listChanged",[n,p])):s(u,t.item,t.offset)?(v=u,u.add(n),u.trigger("selectionChanged",[u]),d.trigger("listChanged",[n,u])):u.sortable("cancel"),t.item.after(n).remove()}),p.on("selectionChanged",r),u.on("selectionChanged",r),p.on("focusin",function(){v=p}),p.on("focusout",function(){v==p&&(v=null)}),u.on("focusin",function(){v=u}),u.on("focusout",function(){v==u&&(v=null)}),e(document).keydown(function(e){if(v)if(38==e.which)if(e.stopPropagation(),e.preventDefault(),e.shiftKey)v.extendSelection(!0);else{var t=v.getSelectedIndex(),n=t-1;0>n&&(n=0),v.selectAt(n)}else if(40==e.which)if(e.stopPropagation(),e.preventDefault(),e.shiftKey)v.extendSelection(!1);else{var t=v.getSelectedIndex(),n=t+1;0>t&&(n=v.getFields().length-1),v.selectAt(n)}else 27==e.which&&v.selectAt(-1)}),this},e.fn.fieldChooser.defaults={helper:function(){return null}}}(jQuery);